#!/usr/bin/env bash

set -Eeu

_script_dir=$(dirname "${BASH_SOURCE[0]}")
_root_dir="${_script_dir}/.."
_module=data-persistence
_autogen_comment="\
#-------------------------------------------------------------------------------
# DO NOT MODIFY BY HAND
# Auto-generated by ${BASH_SOURCE[0]}
#-------------------------------------------------------------------------------
"

#-------------------------------------------------------------------------------
# Generate ${_module}-tf/terraform.tf
#-------------------------------------------------------------------------------

cat <<TF > "${_root_dir}/${_module}-tf/terraform.tf"
${_autogen_comment}
terraform {
  backend "s3" {
    region         = "${AWS_REGION}"
    bucket         = "${TERRAFORM_BACKEND_BUCKET}"
    key            = "${TERRAFORM_BACKEND_KEY_PREFIX}${_module}/terraform.tfstate"
    dynamodb_table = "${TERRAFORM_BACKEND_DYNAMODB_TABLE}"
  }
}
TF

#-------------------------------------------------------------------------------
# Generate ${_module}-tf/terraform.tfvars
#-------------------------------------------------------------------------------

cat <<TF > "${_root_dir}/${_module}-tf/terraform.tfvars"
${_autogen_comment}
aws_region = "${AWS_REGION}"
prefix     = "${PREFIX}"

elasticsearch_config = {
  domain_name    = "es"
  instance_count = 2
  instance_type  = "t2.small.elasticsearch"
  version        = "5.3"
  volume_size    = 10
}

rds_cluster_remote_state_config = {
  bucket = "${TERRAFORM_BACKEND_BUCKET}"
  key    = "${TERRAFORM_BACKEND_KEY_PREFIX}rds-cluster/terraform.tfstate"
  region = "${AWS_REGION}"
}
TF
